name: Build Installer

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-linux-installer:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Build with Gradle
      run: |
        cd hashkitty-java
        ./gradlew clean installDist

    - name: Create Linux Installer (DEB)
      run: |
        # Ensure fakeroot is available (usually is on ubuntu-latest)
        sudo apt-get update && sudo apt-get install -y fakeroot

        # Prepare for jpackage
        # We need the path to the jpackage tool
        JPACKAGE=$JAVA_HOME/bin/jpackage
        INPUT_DIR="hashkitty-java/app/build/install/app/lib"
        MAIN_JAR="app.jar"
        VERSION="1.0.0"

        # Create server properties for add-launcher
        echo "main-class=hashkitty.java.server.ServerApp" > server.properties

        "$JPACKAGE" \
          --name hashkitty \
          --input "$INPUT_DIR" \
          --main-jar "$MAIN_JAR" \
          --main-class "hashkitty.java.App" \
          --app-version "$VERSION" \
          --dest "installer_output" \
          --type deb \
          --add-launcher server=server.properties \
          --java-options "-Djava.library.path=\$APPDIR" \
          --verbose

    - name: Upload Linux Installer
      uses: actions/upload-artifact@v4
      with:
        name: hashkitty-linux-installer
        path: installer_output/*.deb

  build-windows-installer:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Build with Gradle
      run: |
        cd hashkitty-java
        ./gradlew clean installDist

    - name: Create Windows Installer (EXE)
      shell: bash
      run: |
        JPACKAGE="$JAVA_HOME/bin/jpackage"
        INPUT_DIR="hashkitty-java/app/build/install/app/lib"
        MAIN_JAR="app.jar"
        VERSION="1.0.0"

        echo "main-class=hashkitty.java.server.ServerApp" > server.properties

        "$JPACKAGE" \
          --name hashkitty \
          --input "$INPUT_DIR" \
          --main-jar "$MAIN_JAR" \
          --main-class "hashkitty.java.App" \
          --app-version "$VERSION" \
          --dest "installer_output" \
          --type exe \
          --win-dir-chooser \
          --win-menu \
          --win-shortcut \
          --add-launcher server=server.properties \
          --verbose

    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: hashkitty-windows-installer
        path: installer_output/*.exe
